version: 0.2

# ARM64 architecture build specification

env:
  variables:
    # DOCKER_BUILDKIT: '1'
    IMAGE_REPO_NAME: batchbuildgraph
    IMAGE_TAG: latest
    ARCH: arm64
    PLATFORM: linux/arm64
    AWS_ACCOUNT_ID: 992382390146
    AWS_DEFAULT_REGION: us-east-1

phases:
  pre_build:
    commands:
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
      - echo "Building ARM64 architecture on `date`"
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
      
      - echo "Setting up build variables..."
      - REPOSITORY_URI=$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$IMAGE_REPO_NAME
      - echo "Repository URI - $REPOSITORY_URI"
      - echo "Architecture - $ARCH"
      
  build:
    commands:
      - echo "Building Docker image for ARM64..."
      - docker build -t $REPOSITORY_URI:$IMAGE_TAG-$ARCH .
      - echo "Docker build completed successfully"
      
  post_build:
    commands:
      - echo "Pushing ARM64 image to ECR..."
      - docker push $REPOSITORY_URI:$IMAGE_TAG-$ARCH
      - echo "ARM64 build completed on `date`"
      - echo "Image pushed - $REPOSITORY_URI:$IMAGE_TAG-$ARCH"

cache:
  paths:
    - '/root/.cache/pip/**/*'
